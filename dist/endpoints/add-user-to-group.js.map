{"version":3,"sources":["../../src/endpoints/add-user-to-group.ts"],"sourcesContent":["import { addDataAndFileToRequest, CollectionSlug, TypedCollection, type Endpoint } from 'payload'\n\ntype Args = {\n  userSlug: string\n  groupSlug: string\n}\n\ntype AddUserToGroupHandler = (args: Args) => Endpoint['handler']\n\nexport const addUserToGroupHandler: AddUserToGroupHandler = ({ \n  userSlug = 'users', \n  groupSlug = 'groups',\n}) => async (req) => {\n  await addDataAndFileToRequest(req)\n  const data = req.data\n  const user = req.user\n  const payload = req.payload\n  const groupId = data?.groupId\n  const userId = data?.userId\n  const role = data?.role // 'leader' or 'student'\n\n  if (!user || !userId) {\n    return Response.json(\n      { message: 'You must be logged in to add users to a group.' },\n      { status: 401 },\n    )\n  }\n\n  if (!groupId || !userId || !role) {\n    return Response.json(\n      { message: 'Group ID, User ID, and role are required.' },\n      { status: 400 },\n    )\n  }\n\n  if (!['leader', 'student'].includes(role)) {\n    return Response.json(\n      { message: 'Role must be either \"leader\" or \"student\".' },\n      { status: 400 },\n    )\n  }\n\n  try {\n\n    const currentUser = await payload.findByID({\n      collection: userSlug as CollectionSlug,\n      id: userId ? userId : user.id,\n      depth: 1,\n    })\n\n    if (!currentUser) {\n      return Response.json({ message: 'User not found.' }, { status: 404 })\n    }\n\n    const group = await payload.findByID({\n      collection: groupSlug as CollectionSlug,\n      id: groupId,\n      depth: 1,\n    })\n\n    if (!group) {\n      return Response.json({ message: 'Group not found.' }, { status: 404 })\n    }\n\n    // Authorization check: only admins or leaders of the group can add users\n    const isLeader = group.leaders?.some((leader: TypedCollection['users']) => {\n      const leaderId = typeof leader === 'object' ? leader.id : leader\n      return leaderId === currentUser.id\n    })\n    const isAdmin = currentUser.roles?.includes('admin')\n\n    if (!isAdmin && !isLeader) {\n      return Response.json(\n        { message: 'You are not authorized to add users to this group.' },\n        { status: 403 },\n      )\n    }\n\n    // Check if user is already in the group\n    const currentLeaders = (group.leaders?.docs || []).map(\n      (leader: string | TypedCollection[typeof userSlug]) => (typeof leader === 'object' ? leader.id : leader),\n    )\n    const currentStudents = (group.users?.docs || []).map(\n      (student: string | TypedCollection[typeof userSlug]) => (typeof student === 'object' ? student.id : student),\n    )\n\n    if (role === 'leader' && currentLeaders.includes(userId)) {\n      return Response.json({ message: 'User is already a leader in this group.' }, { status: 409 })\n    }\n\n    if (role === 'student' && currentStudents.includes(userId)) {\n      return Response.json({ message: 'User is already a student in this group.' }, { status: 409 })\n    }\n\n    // Add user to the appropriate role\n    const updatedData: Record<string, string[]> = {}\n    \n    if (role === 'leader') {\n      updatedData.leaders = [...currentLeaders, currentUser.id]\n    } else {\n      updatedData.students = [...currentStudents, currentUser.id]\n    }\n    \n    await payload.update({\n      collection: groupSlug as CollectionSlug,\n      id: groupId,\n      data: updatedData,\n    })\n\n    \n\n    payload.logger.info(`User ${userId} added to group ${groupId} as ${role}`)\n\n    return Response.json({ \n      success: true, \n      message: `Successfully added user to group as ${role}.` \n    })\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : 'An unknown error occurred.'\n    payload.logger.error(message)\n    return Response.json({ message }, { status: 500 })\n  }\n}\n"],"names":["addDataAndFileToRequest","addUserToGroupHandler","userSlug","groupSlug","req","data","user","payload","groupId","userId","role","Response","json","message","status","includes","currentUser","findByID","collection","id","depth","group","isLeader","leaders","some","leader","leaderId","isAdmin","roles","currentLeaders","docs","map","currentStudents","users","student","updatedData","students","update","logger","info","success","error","Error"],"mappings":"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"}