{"version":3,"sources":["../../src/endpoints/enroll.ts"],"sourcesContent":["import { addDataAndFileToRequest, CollectionSlug, TypedCollection, type Endpoint } from 'payload'\nimport type { CourseProgress } from '../providers/types.js'\n\ntype Args = {\n  userSlug?: string\n  courseSlug?: string\n  groupSlug?: string\n}\n\ntype EnrollHandler = (args: Args) => Endpoint['handler']\n\nexport const enrollHandler: EnrollHandler = ({ userSlug = 'users', courseSlug = 'courses', groupSlug = 'groups' }) => async (req) => {\n  await addDataAndFileToRequest(req)\n  const data = req.data\n  const user = req.user\n  const payload = req.payload\n  const courseId = data?.courseId\n  const isGroup = data?.isGroup || false\n  const companyName = data?.companyName || ''\n  const userId = data?.userId || ''\n  let isLeader = data?.isLeader || false\n\n  if (!user) {\n    return Response.json({ message: 'You must be logged in to enroll.' }, { status: 401 })\n  }\n\n  if (!courseId) {\n    return Response.json({ message: 'Course ID is required.' }, { status: 400 })\n  }\n\n  try {\n    const currentUser = await payload.findByID({\n      collection: userSlug as CollectionSlug,\n      id: userId ? userId : user.id,\n      depth: 1,\n    })\n\n    const course = await payload.findByID({\n      collection: courseSlug as CollectionSlug,\n      id: courseId,\n      depth: 1,\n    })\n\n    if (!currentUser) {\n      return Response.json({ message: 'User not found.' }, { status: 404 })\n    }\n\n    const enrolledStudentIds = (course?.enrolledStudents || []).map((student: string | TypedCollection[typeof userSlug]) =>\n      typeof student === 'object' ? student.id : student,\n    )\n    const enrolledGroupIds = (course?.enrolledGroups || []).map((group: string | TypedCollection[typeof groupSlug]) =>\n      typeof group === 'object' ? group.id : group,\n    )\n\n    const enrolledCourseIds = (Array.isArray(currentUser.enrolledCourses) ? currentUser.enrolledCourses : []).map(\n      (course: string | TypedCollection[typeof courseSlug]) => (typeof course === 'object' ? course.id : course),\n    )\n\n    const completedCourseIds = (Array.isArray(currentUser.completedCourses) ? currentUser.completedCourses : []).map(\n      (course: string | TypedCollection[typeof courseSlug]) => (typeof course === 'object' ? course.id : course),\n    )\n    \n    if (isGroup) {\n      if (!companyName) {\n        payload.logger.error('Company name is required for group enrollment.')\n        return Response.json({ message: 'Company name is required for group enrollment.' }, { status: 400 })\n      }\n\n      let group: TypedCollection[typeof groupSlug] | null = null\n\n      if (groupSlug) {\n        const { docs: existingGroups }= await payload.find({\n          collection: groupSlug as CollectionSlug,\n          where: {\n            title: {\n              equals: companyName,\n            },\n          },\n          depth: 1,\n        })\n\n        if (existingGroups.length > 0) {\n          group = existingGroups[0] || null\n          payload.logger.info(`Found existing group '${companyName}' with id ${group?.id}`)\n         \n          const currentLeaders = (group.leaders || []).map((leader: string | TypedCollection[typeof userSlug]) =>\n            typeof leader === 'string' ? leader : leader.id,\n          )\n          const currentStudents = (group.students || []).map((student: string | TypedCollection[typeof userSlug]) =>\n            typeof student === 'string' ? student : student.id,\n          )\n\n          const currentCourses = (group.courses || []).map((c: string | TypedCollection[typeof courseSlug]) =>\n            typeof c === 'string' ? c : c.id,\n          )\n\n          const updatedData: Partial<TypedCollection[typeof groupSlug]> = {}\n\n          if (isLeader && !currentLeaders.includes(user.id)) {\n            updatedData.leaders = [...currentLeaders, user.id]\n          }\n\n          if (!isLeader && !currentStudents.includes(user.id)) {\n            updatedData.students = [...currentStudents, user.id]\n          }\n\n          if (!currentCourses.includes(courseId)) {\n            updatedData.courses = [...currentCourses, courseId]\n          }\n\n          if (Object.keys(updatedData).length > 0) {\n            await payload.update({\n              collection: 'groups',\n              id: group.id,\n              data: updatedData,\n            })\n            payload.logger.info(`Updated group ${group.id} with new student/course.`)\n          } else {\n            payload.logger.info(`Group ${group.id} already up-to-date.`)\n          }\n          \n\n        } else {\n          payload.logger.info(`No existing group found for '${companyName}'`)\n          const newGroupData = {\n            title: companyName,\n            ...(isLeader ? { leaders: [user.id] } : { students: [user.id] }),\n            courses: [courseId],\n          }\n          \n          const newGroup = await payload.create({\n            collection: 'groups',\n            data: newGroupData,\n          })\n          group = newGroup\n          payload.logger.info(`Created new group '${companyName}' with id ${group?.id}`)\n        }\n\n          // Add group to course's courseEnrolledGroups array\n          const currentEnrolledGroups = (course.courseEnrolledGroups || []).map(\n            (g: string | TypedCollection[typeof groupSlug]) => (typeof g === 'string' ? g : g.id),\n          )\n\n          if (!currentEnrolledGroups.includes(group.id)) {\n            await payload.update({\n              collection: courseSlug as CollectionSlug,\n              id: courseId,\n              data: {\n                courseEnrolledGroups: [...currentEnrolledGroups, group.id],\n              },\n            })\n            payload.logger.info(\n              `Added group ${group.title} to course ${course.title}'s enrolled groups`,\n            )\n          } else {\n            payload.logger.info(\n              `Group ${group.title} is already enrolled in course ${course.title}`,\n            )\n          }\n      \n      }\n\n    }\n  \n    // Initialize course progress for the user\n    const coursesProgress = Array.isArray(currentUser.coursesProgress) ? currentUser.coursesProgress : []\n\n        \n    // Check if course progress already exists for this course\n    const courseProgressExists = coursesProgress.some((progress: CourseProgress) => {\n      if (typeof progress.course === 'object' && progress.course !== null) {\n        return progress.course.id === courseId\n      }\n      return progress.course === courseId\n    })\n\n\n    if (\n      enrolledStudentIds?.includes(user.id) ||\n      enrolledCourseIds.includes(courseId)\n    ) {\n        \n       if (!courseProgressExists) {\n          // Create new course progress entry\n          const newCourseProgress = {\n            course: courseId,\n            completed: false,\n            completedLessons: [],\n            completedQuizzes: [],\n          }\n          \n          await payload.update({\n            collection: userSlug as CollectionSlug,\n            id: currentUser.id,\n            data: {\n              coursesProgress: [...coursesProgress, newCourseProgress],\n            },\n          })\n\n\n          payload.logger.info(`User ${currentUser.id} course progress created for course ${courseId}`)\n        }\n\n      return Response.json({ message: 'You are already enrolled in this course.' }, { status: 409 })\n    }\n\n    if (\n      completedCourseIds.includes(courseId) \n    ) {\n      return Response.json({ message: 'You have already completed this course.' }, { status: 409 })\n    }\n\n    await payload.update({\n      collection: courseSlug as CollectionSlug,\n      id: courseId,\n      data: {\n        enrolledStudents: [...enrolledStudentIds, user.id],\n      },\n    })\n\n\n    \n    if (!courseProgressExists) {\n      // Create new course progress entry\n      const newCourseProgress = {\n        course: courseId,\n        completed: false,\n        completedLessons: [],\n        completedQuizzes: [],\n      }\n      \n      await payload.update({\n        collection: userSlug as CollectionSlug,\n        id: currentUser.id,\n        data: {\n          coursesProgress: [...coursesProgress, newCourseProgress],\n        },\n      })\n      payload.logger.info(`User ${currentUser.id} course progress created for course ${courseId}`)\n    }\n\n    payload.logger.info(`User ${currentUser.id} enrolled in course ${courseId}`)\n\n    return Response.json({ success: true, message: 'Successfully enrolled in course.' })\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : 'An unknown error occurred.'\n    payload.logger.error(message)\n    return Response.json({ message }, { status: 500 })\n  }\n}\n"],"names":["addDataAndFileToRequest","enrollHandler","userSlug","courseSlug","groupSlug","req","data","user","payload","courseId","isGroup","companyName","userId","isLeader","Response","json","message","status","currentUser","findByID","collection","id","depth","course","enrolledStudentIds","enrolledStudents","map","student","enrolledGroupIds","enrolledGroups","group","enrolledCourseIds","Array","isArray","enrolledCourses","completedCourseIds","completedCourses","logger","error","docs","existingGroups","find","where","title","equals","length","info","currentLeaders","leaders","leader","currentStudents","students","currentCourses","courses","c","updatedData","includes","Object","keys","update","newGroupData","newGroup","create","currentEnrolledGroups","courseEnrolledGroups","g","coursesProgress","courseProgressExists","some","progress","newCourseProgress","completed","completedLessons","completedQuizzes","success","Error"],"mappings":"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"}