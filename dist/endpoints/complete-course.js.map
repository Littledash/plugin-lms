{"version":3,"sources":["../../src/endpoints/complete-course.ts"],"sourcesContent":["import { addDataAndFileToRequest, CollectionSlug, TypedCollection, type Endpoint } from 'payload'\n\ntype Args = {\n  userSlug: string\n  courseSlug: string\n}\n\ntype CompleteCourseHandler = (args: Args) => Endpoint['handler']\n\nexport const completeCourseHandler: CompleteCourseHandler = ({ userSlug = 'users', courseSlug = 'courses'\n}) => \nasync (req) => {\n  await addDataAndFileToRequest(req)\n  const data = req.data\n  const user = req.user\n  const payload = req.payload\n  const courseId = data?.courseId\n\n  if (!user) {\n    return Response.json(\n      { message: 'You must be logged in to complete a course.' },\n      { status: 401 },\n    )\n  }\n\n  if (!courseId) {\n    return Response.json({ message: 'Course ID is required.' }, { status: 400 })\n  }\n\n  try {\n    const currentUser = await payload.findByID({\n      collection: userSlug as CollectionSlug,\n      id: user.id,\n      depth: 1,\n    })\n\n    if (!currentUser) {\n      return Response.json({ message: 'User not found.' }, { status: 404 })\n    }\n\n    const course = await payload.findByID({\n      collection: courseSlug as CollectionSlug,\n      id: courseId,\n      depth: 1,\n    })\n\n    const enrolledCourses = (currentUser.enrolledCourses?.docs || []).map(\n      (course: string | TypedCollection[typeof courseSlug]) => (typeof course === 'object' ? course.id : course),\n    )\n    const completedCourses = (currentUser.completedCourses?.docs || []).map(\n      (course: string | TypedCollection[typeof courseSlug]) => (typeof course === 'object' ? course.id : course),\n    )\n\n    if (!enrolledCourses.includes(courseId)) {\n      return Response.json({ message: 'You are not enrolled in this course.' }, { status: 409 })\n    }\n\n    if (completedCourses.includes(courseId)) {\n      return Response.json({ message: 'You have already completed this course.' }, { status: 409 })\n    }\n\n    // Update course collection - add student to courseCompletedStudents while keeping them enrolled\n    const courseCompletedStudents = (course.courseCompletedStudents?.docs || []).map(\n      (student: string | TypedCollection[typeof userSlug]) => (typeof student === 'object' ? student.id : student),\n    )\n\n    // Only add to completed students if not already there\n    if (!courseCompletedStudents.includes(user.id)) {\n      await payload.update({\n        collection: courseSlug as CollectionSlug,\n        id: courseId,\n        data: {\n          courseCompletedStudents: [...courseCompletedStudents, user.id],\n        },\n      })\n    }\n\n    payload.logger.info(`User ${user.id} completed course ${courseId}`)\n\n    return Response.json({ success: true, message: 'Successfully completed course.' })\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : 'An unknown error occurred.'\n    payload.logger.error(message)\n    return Response.json({ message }, { status: 500 })\n  }\n}\n"],"names":["addDataAndFileToRequest","completeCourseHandler","userSlug","courseSlug","req","data","user","payload","courseId","Response","json","message","status","currentUser","findByID","collection","id","depth","course","enrolledCourses","docs","map","completedCourses","includes","courseCompletedStudents","student","update","logger","info","success","error","Error"],"mappings":"AAAA,SAASA,uBAAuB,QAAwD,UAAS;AASjG,OAAO,MAAMC,wBAA+C,CAAC,EAAEC,WAAW,OAAO,EAAEC,aAAa,SAAS,EACxG,GACD,OAAOC;QACL,MAAMJ,wBAAwBI;QAC9B,MAAMC,OAAOD,IAAIC,IAAI;QACrB,MAAMC,OAAOF,IAAIE,IAAI;QACrB,MAAMC,UAAUH,IAAIG,OAAO;QAC3B,MAAMC,WAAWH,MAAMG;QAEvB,IAAI,CAACF,MAAM;YACT,OAAOG,SAASC,IAAI,CAClB;gBAAEC,SAAS;YAA8C,GACzD;gBAAEC,QAAQ;YAAI;QAElB;QAEA,IAAI,CAACJ,UAAU;YACb,OAAOC,SAASC,IAAI,CAAC;gBAAEC,SAAS;YAAyB,GAAG;gBAAEC,QAAQ;YAAI;QAC5E;QAEA,IAAI;YACF,MAAMC,cAAc,MAAMN,QAAQO,QAAQ,CAAC;gBACzCC,YAAYb;gBACZc,IAAIV,KAAKU,EAAE;gBACXC,OAAO;YACT;YAEA,IAAI,CAACJ,aAAa;gBAChB,OAAOJ,SAASC,IAAI,CAAC;oBAAEC,SAAS;gBAAkB,GAAG;oBAAEC,QAAQ;gBAAI;YACrE;YAEA,MAAMM,SAAS,MAAMX,QAAQO,QAAQ,CAAC;gBACpCC,YAAYZ;gBACZa,IAAIR;gBACJS,OAAO;YACT;YAEA,MAAME,kBAAkB,AAACN,CAAAA,YAAYM,eAAe,EAAEC,QAAQ,EAAE,AAAD,EAAGC,GAAG,CACnE,CAACH,SAAyD,OAAOA,WAAW,WAAWA,OAAOF,EAAE,GAAGE;YAErG,MAAMI,mBAAmB,AAACT,CAAAA,YAAYS,gBAAgB,EAAEF,QAAQ,EAAE,AAAD,EAAGC,GAAG,CACrE,CAACH,SAAyD,OAAOA,WAAW,WAAWA,OAAOF,EAAE,GAAGE;YAGrG,IAAI,CAACC,gBAAgBI,QAAQ,CAACf,WAAW;gBACvC,OAAOC,SAASC,IAAI,CAAC;oBAAEC,SAAS;gBAAuC,GAAG;oBAAEC,QAAQ;gBAAI;YAC1F;YAEA,IAAIU,iBAAiBC,QAAQ,CAACf,WAAW;gBACvC,OAAOC,SAASC,IAAI,CAAC;oBAAEC,SAAS;gBAA0C,GAAG;oBAAEC,QAAQ;gBAAI;YAC7F;YAEA,gGAAgG;YAChG,MAAMY,0BAA0B,AAACN,CAAAA,OAAOM,uBAAuB,EAAEJ,QAAQ,EAAE,AAAD,EAAGC,GAAG,CAC9E,CAACI,UAAwD,OAAOA,YAAY,WAAWA,QAAQT,EAAE,GAAGS;YAGtG,sDAAsD;YACtD,IAAI,CAACD,wBAAwBD,QAAQ,CAACjB,KAAKU,EAAE,GAAG;gBAC9C,MAAMT,QAAQmB,MAAM,CAAC;oBACnBX,YAAYZ;oBACZa,IAAIR;oBACJH,MAAM;wBACJmB,yBAAyB;+BAAIA;4BAAyBlB,KAAKU,EAAE;yBAAC;oBAChE;gBACF;YACF;YAEAT,QAAQoB,MAAM,CAACC,IAAI,CAAC,CAAC,KAAK,EAAEtB,KAAKU,EAAE,CAAC,kBAAkB,EAAER,UAAU;YAElE,OAAOC,SAASC,IAAI,CAAC;gBAAEmB,SAAS;gBAAMlB,SAAS;YAAiC;QAClF,EAAE,OAAOmB,OAAgB;YACvB,MAAMnB,UAAUmB,iBAAiBC,QAAQD,MAAMnB,OAAO,GAAG;YACzDJ,QAAQoB,MAAM,CAACG,KAAK,CAACnB;YACrB,OAAOF,SAASC,IAAI,CAAC;gBAAEC;YAAQ,GAAG;gBAAEC,QAAQ;YAAI;QAClD;IACF,EAAC"}