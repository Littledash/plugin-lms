{"version":3,"sources":["../../src/endpoints/submit-quiz.ts"],"sourcesContent":["import { addDataAndFileToRequest, CollectionSlug, type Endpoint, TypedCollection } from 'payload'\n\ntype Args = {\n  userSlug: string\n  quizzesSlug: string\n}\n\ntype SubmitQuizHandler = (args: Args) => Endpoint['handler']\n\nexport const submitQuizHandler: SubmitQuizHandler = ({ userSlug = 'users', quizzesSlug = 'quizzes' }) => async (req) => {\n  await addDataAndFileToRequest(req)\n  const data = req.data\n  const user = req.user\n  const payload = req.payload\n  const courseId = data?.courseId\n  const quizId = data?.quizId\n  const answers = data?.answers\n\n  if (!user) {\n    return Response.json({ message: 'You must be logged in to submit a quiz.' }, { status: 401 })\n  }\n\n  if (!courseId || !quizId || !answers) {\n    return Response.json(\n      { message: 'Course ID, Quiz ID, and answers are required.' },\n      { status: 400 },\n    )\n  }\n\n  try {\n    const quiz = await payload.findByID({\n      collection: quizzesSlug as CollectionSlug,\n      id: quizId,\n      depth: 2, // Eager load questions and their answers\n    })\n\n    if (!quiz) {\n      return Response.json({ message: 'Quiz not found.' }, { status: 404 })\n    }\n\n    // Basic grading logic\n    let correctAnswers = 0\n    if (quiz.questions && Array.isArray(quiz.questions)) {\n      for (const question of quiz.questions) {\n        if (\n          question &&\n          typeof question === 'object' &&\n          'answers' in question &&\n          Array.isArray(question.answers)\n        ) {\n          const submittedAnswer = answers[question.id]\n          const correctAnswer = question.answers.find((a: { isCorrect: boolean; id: string }) => a.isCorrect)?.id\n          if (submittedAnswer === correctAnswer) {\n            correctAnswers++\n          }\n        }\n      }\n    }\n    const score = quiz.questions.length > 0 ? (correctAnswers / quiz.questions.length) * 100 : 0\n\n    const currentUser = await payload.findByID({\n      collection: userSlug as CollectionSlug,\n      id: user.id,\n    })\n\n    if (!currentUser) {\n      return Response.json({ message: 'User not found.' }, { status: 404 })\n    }\n\n    const coursesProgress = currentUser.coursesProgress || []\n    let courseProgressIndex = coursesProgress.findIndex((cp: { course: string | { id: string } }) => {\n      // Handle both full course objects and course IDs for backward compatibility\n      if (typeof cp.course === 'object' && cp.course !== null) {\n        return cp.course.id === courseId\n      }\n      return cp.course === courseId\n    })\n    \n    if (courseProgressIndex === -1) {\n      // Create new course progress entry\n      coursesProgress.push({\n        course: courseId,\n        completed: false,\n        completedLessons: [],\n        completedQuizzes: [],\n      })\n      courseProgressIndex = coursesProgress.length - 1\n    }\n    \n    const courseProgress = coursesProgress[courseProgressIndex]\n    const quizExists = courseProgress.completedQuizzes.some((cq: { quiz: string | { id: string } }) => {\n      // Handle both full quiz objects and quiz IDs for backward compatibility\n      if (typeof cq.quiz === 'object' && cq.quiz !== null) {\n        return cq.quiz.id === quizId\n      }\n      return cq.quiz === quizId\n    })\n    \n    if (!quizExists) {\n      courseProgress.completedQuizzes.push({\n        quiz: quizId,\n        score: score,\n        completedAt: new Date().toISOString(),\n      })\n    } else {\n      // Update existing quiz score\n      const quizIndex = courseProgress.completedQuizzes.findIndex((cq: { quiz: string | { id: string } }) => {\n        // Handle both full quiz objects and quiz IDs for backward compatibility\n        if (typeof cq.quiz === 'object' && cq.quiz !== null) {\n          return cq.quiz.id === quizId\n        }\n        return cq.quiz === quizId\n      })\n      if (quizIndex !== -1) {\n        courseProgress.completedQuizzes[quizIndex].score = score\n        courseProgress.completedQuizzes[quizIndex].completedAt = new Date().toISOString()\n      }\n    }\n\n    await payload.update({\n      collection: userSlug as CollectionSlug,\n      id: user.id,\n      data: {\n        coursesProgress,\n      },\n    })\n\n    payload.logger.info(\n      `User ${user.id} submitted quiz ${quizId} in course ${courseId} and scored ${score}`,\n    )\n\n    if ( score >= quiz.minimumScore ) {\n      // Mark the lesson as completed if quiz is passed\n      const lessonId = quiz.lesson\n      if (lessonId) {\n        const lessonExists = courseProgress.completedLessons.some((cl: { lesson: string | { id: string } }) => {\n          // Handle both full lesson objects and lesson IDs for backward compatibility\n          if (typeof cl.lesson === 'object' && cl.lesson !== null) {\n            return cl.lesson.id === lessonId\n          }\n          return cl.lesson === lessonId\n        })\n        \n        if (!lessonExists) {\n          // Add the completed lesson\n          courseProgress.completedLessons.push({\n            lesson: lessonId,\n            completedAt: new Date().toISOString(),\n          })\n        }\n      }\n\n      // Check if all lessons in the course are completed\n      try {\n        const course = await payload.findByID({\n          collection: 'courses' as CollectionSlug,\n          id: courseId,\n          depth: 1,\n        })\n\n        if (course && course.lessons) {\n          // Count total required lessons (non-optional)\n          const totalRequiredLessons = course.lessons.filter((lessonItem: { lesson: string | { id: string }, isOptional?: boolean }) => !lessonItem.isOptional)\n          \n          // Get completed lesson IDs\n          const completedLessonIds = courseProgress.completedLessons.map((lesson: { lesson: string | { id: string } }) => \n            typeof lesson.lesson === 'object' && lesson.lesson !== null ? lesson.lesson.id : lesson.lesson\n          )\n          \n          // Check if all required lessons are completed\n          const allRequiredLessonsCompleted = totalRequiredLessons.every((lessonItem: { lesson: string | { id: string } }) => {\n            const lessonId = typeof lessonItem.lesson === 'object' && lessonItem.lesson !== null ? lessonItem.lesson.id : lessonItem.lesson\n            return completedLessonIds.includes(lessonId)\n          })\n\n          if (allRequiredLessonsCompleted && !courseProgress.completed) {\n            // Mark course as completed\n            courseProgress.completed = true\n            courseProgress.completedAt = new Date().toISOString()\n            \n            // Update course collection - add student to courseCompletedStudents and remove from enrolledStudents\n            const enrolledStudentIds = (Array.isArray(course.enrolledStudents) ? course.enrolledStudents : []).map(\n              (student: string | TypedCollection[typeof userSlug]) => (typeof student === 'object' ? student.id : student),\n            )\n            const courseCompletedStudents = (Array.isArray(course.courseCompletedStudents) ? course.courseCompletedStudents : []).map(\n              (student: string | TypedCollection[typeof userSlug]) => (typeof student === 'object' ? student.id : student),\n            )\n\n            // Remove user from enrolledStudents and add to courseCompletedStudents\n            const updatedEnrolledStudents = enrolledStudentIds.filter(id => id !== user.id)\n            const updatedCompletedStudents = courseCompletedStudents.includes(user.id) \n              ? courseCompletedStudents \n              : [...courseCompletedStudents, user.id]\n\n            await payload.update({\n              collection: 'courses' as CollectionSlug,\n              id: courseId,\n              data: {\n                enrolledStudents: updatedEnrolledStudents,\n                courseCompletedStudents: updatedCompletedStudents,\n              },\n            })\n\n            payload.logger.info(`User ${user.id} completed course ${courseId} after passing quiz ${quizId}`)\n          }\n        }\n      } catch (error) {\n        payload.logger.warn(`Could not check course completion for course ${courseId}: ${error}`)\n      }\n\n      // Update user progress with the new lesson completion and potential course completion\n      await payload.update({\n        collection: userSlug as CollectionSlug,\n        id: user.id,\n        data: {\n          coursesProgress,\n        },\n      })\n      \n      return Response.json({ success: true, message: 'Quiz submitted successfully and successfully passed', score, passed: true })\n    }\n\n    return Response.json({ success: true, message: 'Quiz submitted successfully but you did not pass. You can try again. Required score: ' + quiz.minimumScore + '%', score, passed: false })\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : 'An unknown error occurred submitting quiz. Please try again.'\n    payload.logger.error(message)\n    return Response.json({ message, passed: false, score: 0 }, { status: 500 })\n  }\n}\n"],"names":["addDataAndFileToRequest","submitQuizHandler","userSlug","quizzesSlug","req","data","user","payload","courseId","quizId","answers","Response","json","message","status","quiz","findByID","collection","id","depth","correctAnswers","questions","Array","isArray","question","submittedAnswer","correctAnswer","find","a","isCorrect","score","length","currentUser","coursesProgress","courseProgressIndex","findIndex","cp","course","push","completed","completedLessons","completedQuizzes","courseProgress","quizExists","some","cq","completedAt","Date","toISOString","quizIndex","update","logger","info","minimumScore","lessonId","lesson","lessonExists","cl","lessons","totalRequiredLessons","filter","lessonItem","isOptional","completedLessonIds","map","allRequiredLessonsCompleted","every","includes","enrolledStudentIds","enrolledStudents","student","courseCompletedStudents","updatedEnrolledStudents","updatedCompletedStudents","error","warn","success","passed","Error"],"mappings":"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"}