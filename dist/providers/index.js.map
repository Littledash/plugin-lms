{"version":3,"sources":["../../src/providers/index.tsx"],"sourcesContent":["'use client'\n\nimport React, { createContext, use, useCallback, useEffect, useReducer } from 'react'\nimport type { DefaultDocumentIDType } from 'payload'\nimport * as qs from 'qs-esm'\nimport { LMSContextType, LMSProviderProps, CourseProgress } from './types.js'\nimport { lmsReducer, initialState, type LMSState } from './reducer.js'\n\nconst defaultContext: LMSContextType = {\n  users: [],\n  courses: [],\n  topics: [],\n  lessons: [],\n  progress: [],\n  quizzes: [],\n  certificates: [],\n  enrolledCourses: [],\n  completedCourses: [],\n  quizStarted: null,\n  enroll: async () => {},\n  completeCourse: async () => {},\n  completeLesson: async () => {},\n  startQuiz: async () => {},\n  setQuizCompleted: async () => {},\n  setQuizExited: async () => {},\n  submitQuiz: async () => {\n    return {\n      passed: false,\n      score: 0,\n      message: 'An unknown error occurred submitting quiz. Please try again.',\n    }\n  },\n  addUserToGroup: async () => {},\n  getProgress: () => undefined,\n  fetchProgress: async () => {},\n  fetchUsers: async () => {},\n  fetchCourses: async () => {},\n  fetchTopics: async () => {},\n  fetchLessons: async () => {},\n  fetchQuizzes: async () => {},\n  isLoading: false,\n  error: null,\n}\n\nconst LMSContext = createContext<LMSContextType>(defaultContext)\n\nconst defaultLocalStorage = {\n  key: 'lms',\n}\n\nexport const LMSProvider: React.FC<LMSProviderProps> = ({\n  children,\n  api,\n  syncLocalStorage = true,\n}) => {\n  const localStorageConfig =\n    syncLocalStorage && typeof syncLocalStorage === 'object'\n      ? {\n          ...defaultLocalStorage,\n          ...(syncLocalStorage as Record<string, unknown>),\n        }\n      : defaultLocalStorage\n\n  const { apiRoute = '/api', serverURL = '' } = api || {}\n  const baseAPIURL = `${serverURL}${apiRoute}`\n\n  const [state, dispatch] = useReducer(lmsReducer, initialState)\n\n  const fetchProgress = useCallback(async () => {\n    dispatch({ type: 'SET_LOADING', payload: true })\n    dispatch({ type: 'SET_ERROR', payload: null })\n    try {\n      const response = await fetch(\n        `${baseAPIURL}/lms/fetch-progress`,\n        {\n          method: 'GET',\n          headers: { 'Content-Type': 'application/json' },\n          credentials: 'include',\n        }\n      )\n      \n      // Handle 401 (Unauthorized) - user is not logged in, this is expected\n      if (response.status === 401) {\n        // User is not logged in, silently return without setting error\n        return\n      }\n      \n      if (!response.ok) throw new Error('Failed to fetch user progress')\n      const data = await response.json()\n      const { coursesProgress, enrolledCourses, completedCourses } = data\n      \n      // Update all progress-related state\n      dispatch({ type: 'UPDATE_PROGRESS', payload: coursesProgress || [] })\n      \n      // Ensure enrolledCourses is an array before mapping\n      const enrolledCoursesArray = Array.isArray(enrolledCourses) ? enrolledCourses : []\n      dispatch({ type: 'SET_ENROLLED_COURSES', payload: enrolledCoursesArray.map((course: { id: DefaultDocumentIDType }) => course.id) })\n      \n      // Ensure completedCourses is an array before mapping\n      const completedCoursesArray = Array.isArray(completedCourses) ? completedCourses : []\n      dispatch({ type: 'SET_COMPLETED_COURSES', payload: completedCoursesArray.map((course: { id: DefaultDocumentIDType }) => course.id) })\n    } catch (e: unknown) {\n      dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n    } finally {\n      dispatch({ type: 'SET_LOADING', payload: false })\n    }\n  }, [baseAPIURL])\n\n  // Load progress and course status from database on initial render\n  useEffect(() => {\n    if (syncLocalStorage) {\n      // First try to load from localStorage for immediate UI rendering\n      const storedProgress = localStorage.getItem(localStorageConfig.key)\n      if (storedProgress) {\n        const parsed = JSON.parse(storedProgress)\n        \n        // Normalize progress data to use IDs only for backward compatibility\n        const normalizedProgress = (parsed.progress || []).map((progress: CourseProgress) => ({\n          ...progress,\n          course: typeof progress.course === 'object' && progress.course !== null ? progress.course.id : progress.course,\n          completedLessons: progress.completedLessons?.map((lesson) => ({\n            ...lesson,\n            lesson: typeof lesson.lesson === 'object' && lesson.lesson !== null ? lesson.lesson.id : lesson.lesson,\n          })) || [],\n          completionPercentage: progress.completionPercentage || 0,\n          courseCompletion: progress.courseCompletion || '',\n          completedQuizzes: progress.completedQuizzes?.map((quiz) => ({\n            ...quiz,\n            quiz: typeof quiz.quiz === 'object' && quiz.quiz !== null ? quiz.quiz.id : quiz.quiz,\n          })) || [],\n        }))\n        \n        // Normalize enrolled and completed courses to use IDs only\n        const normalizedEnrolledCourses = (parsed.enrolledCourses || []).map((course: DefaultDocumentIDType | { id: DefaultDocumentIDType }) => \n          typeof course === 'object' && course !== null ? course.id : course\n        )\n        const normalizedCompletedCourses = (parsed.completedCourses || []).map((course: DefaultDocumentIDType | { id: DefaultDocumentIDType }) => \n          typeof course === 'object' && course !== null ? course.id : course\n        )\n        \n        dispatch({\n          type: 'LOAD_FROM_STORAGE',\n          payload: {\n            progress: normalizedProgress,\n            enrolledCourses: normalizedEnrolledCourses,\n            completedCourses: normalizedCompletedCourses,\n          },\n        })\n      }\n      \n      // Then fetch fresh data from database\n      fetchProgress()\n    }\n  }, [syncLocalStorage, localStorageConfig.key, fetchProgress])\n\n  // Persist progress and course status to localStorage whenever they change\n  useEffect(() => {\n    if (syncLocalStorage) {\n      const serializedState = JSON.stringify({\n        progress: state.progress,\n        enrolledCourses: state.enrolledCourses,\n        completedCourses: state.completedCourses,\n      })\n      localStorage.setItem(localStorageConfig.key, serializedState)\n    }\n  }, [state.progress, state.enrolledCourses, state.completedCourses, syncLocalStorage, localStorageConfig.key])\n\n  const enroll = useCallback(\n    async (\n      courseId: DefaultDocumentIDType,\n      options?: {\n        isGroup?: boolean\n        companyName?: string\n        isLeader?: boolean\n        userId?: DefaultDocumentIDType\n      }\n    ) => {\n      dispatch({ type: 'SET_LOADING', payload: true })\n      dispatch({ type: 'SET_ERROR', payload: null })\n      try {\n        const requestBody: {\n          courseId: DefaultDocumentIDType\n          isGroup?: boolean\n          companyName?: string\n          isLeader?: boolean\n          userId?: DefaultDocumentIDType\n        } = { courseId }\n\n        if (options?.isGroup !== undefined) {\n          requestBody.isGroup = options.isGroup\n        }\n        if (options?.companyName) {\n          requestBody.companyName = options.companyName\n        }\n        if (options?.isLeader !== undefined) {\n          requestBody.isLeader = options.isLeader\n        }\n        if (options?.userId) {\n          requestBody.userId = options.userId\n        }\n\n        const response = await fetch(`${baseAPIURL}/lms/enroll`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          credentials: 'include',\n          body: JSON.stringify(requestBody),\n        })\n        if (!response.ok) throw new Error('Failed to enroll in course')\n        await fetchProgress() // Refetch progress to ensure state is up-to-date\n      } catch (e: unknown) {\n        dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n      } finally {\n        dispatch({ type: 'SET_LOADING', payload: false })\n      }\n    },\n    [baseAPIURL, fetchProgress],\n  )\n\n  const completeCourse = useCallback(\n    async (courseId: DefaultDocumentIDType, options?: { userId?: DefaultDocumentIDType }) => {\n      dispatch({ type: 'SET_LOADING', payload: true })\n      dispatch({ type: 'SET_ERROR', payload: null })\n      try {\n        const requestBody: {\n          courseId: DefaultDocumentIDType\n          userId?: DefaultDocumentIDType\n        } = { courseId }\n\n        if (options?.userId) {\n          requestBody.userId = options.userId\n        }\n\n        const response = await fetch(`${baseAPIURL}/lms/complete-course`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          credentials: 'include',\n          body: JSON.stringify(requestBody),\n        })\n        if (!response.ok) throw new Error('Failed to complete course')\n        await fetchProgress() // Refetch progress to ensure state is up-to-date\n      } catch (e: unknown) {\n        dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n      } finally {\n        dispatch({ type: 'SET_LOADING', payload: false })\n      }\n    },\n    [baseAPIURL, fetchProgress],\n  )\n\n  const completeLesson = useCallback(\n    async (courseId: DefaultDocumentIDType, lessonId: DefaultDocumentIDType) => {\n      dispatch({ type: 'SET_LOADING', payload: true })\n      dispatch({ type: 'SET_ERROR', payload: null })\n      try {\n        await fetch(`${baseAPIURL}/lms/complete-lesson`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          credentials: 'include',\n          body: JSON.stringify({ courseId, lessonId }),\n        })\n        await fetchProgress() // Refetch progress to ensure state is up-to-date\n      } catch (e: unknown) {\n        dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n      } finally {\n        dispatch({ type: 'SET_LOADING', payload: false })\n      }\n    },\n    [baseAPIURL, fetchProgress],\n  )\n\n  const startQuiz = useCallback(\n    async (quizId: DefaultDocumentIDType, courseId: DefaultDocumentIDType) => {\n      dispatch({ type: 'SET_LOADING', payload: true })\n      dispatch({ type: 'SET_ERROR', payload: null })\n      dispatch({ type: 'SET_QUIZ_STARTED', payload: { quizId, courseId, startedAt: new Date().toISOString() } })\n      \n    },\n    [],\n  )\n\n  const setQuizCompleted = useCallback(\n    async (quizId: DefaultDocumentIDType, score: number) => {\n      dispatch({ type: 'SET_QUIZ_COMPLETED', payload: { quizId, completedAt: new Date().toISOString(), score } })\n    },\n    [],\n  )\n\n  const setQuizExited = useCallback(\n    async (quizId: DefaultDocumentIDType, courseId: DefaultDocumentIDType) => {\n      dispatch({ type: 'SET_QUIZ_EXITED', payload: { quizId, courseId, exitedAt: new Date().toISOString() } })\n    },\n    [],\n  )\n\n  const submitQuiz = useCallback(\n    async (courseId: DefaultDocumentIDType, quizId: DefaultDocumentIDType, answers: Record<string, unknown>) => {\n      dispatch({ type: 'SET_LOADING', payload: true })\n      dispatch({ type: 'SET_ERROR', payload: null })\n      try {\n        const response = await fetch(`${baseAPIURL}/lms/submit-quiz`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          credentials: 'include',\n          body: JSON.stringify({ courseId, quizId, answers }),\n        })\n        if (!response.ok) throw new Error('Failed to submit quiz')\n        const data = await response.json()\n        if (data.passed) {\n          dispatch({ type: 'SET_QUIZ_COMPLETED', payload: { quizId, completedAt: new Date().toISOString(), score: data.score } })\n          \n        }\n        await fetchProgress() // Refetch progress to ensure state is up-to-date\n        return data // Return the response data\n      } catch (e: unknown) {\n        dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n        return {\n          passed: false,\n          score: 0,\n          message: 'An unknown error occurred submitting quiz. Please try again.',\n        }\n      } finally {\n        dispatch({ type: 'SET_LOADING', payload: false })\n      }\n    },\n    [baseAPIURL, fetchProgress],\n  )\n\n  const addUserToGroup = useCallback(\n    async (groupId: DefaultDocumentIDType, userId: DefaultDocumentIDType, role: 'leader' | 'student') => {\n      dispatch({ type: 'SET_LOADING', payload: true })\n      dispatch({ type: 'SET_ERROR', payload: null })\n      try {\n        const response = await fetch(`${baseAPIURL}/lms/add-user-to-group`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          credentials: 'include',\n          body: JSON.stringify({ groupId, userId, role }),\n        })\n        if (!response.ok) throw new Error('Failed to add user to group')\n      } catch (e: unknown) {\n        dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n      } finally {\n        dispatch({ type: 'SET_LOADING', payload: false })\n      }\n    },\n    [baseAPIURL],\n  )\n\n  const getProgress = useCallback(\n    (courseId: DefaultDocumentIDType, refreshFromDB = false) => {\n      if (refreshFromDB) {\n        // Fetch fresh progress from database\n        fetchProgress()\n      }\n      return state.progress.find((cp) => {\n        // Handle both full course objects and course IDs for backward compatibility\n        if (typeof cp.course === 'object' && cp.course !== null) {\n          return cp.course.id === courseId\n        }\n        return cp.course === courseId\n      })\n    },\n    [state.progress, fetchProgress],\n  )\n\n  const fetchUsers = useCallback(async () => {\n    dispatch({ type: 'SET_LOADING', payload: true })\n    dispatch({ type: 'SET_ERROR', payload: null })\n    try {\n      const response = await fetch(`${baseAPIURL}/users`)\n      if (!response.ok) throw new Error('Failed to fetch users')\n      const data = await response.json()\n      dispatch({ type: 'SET_USERS', payload: data.docs })\n    } catch (e: unknown) {\n      dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n      dispatch({ type: 'SET_USERS', payload: [] })\n    } finally {\n      dispatch({ type: 'SET_LOADING', payload: false })\n    }\n  }, [baseAPIURL])\n\n  const fetchCourses = useCallback(async () => {\n    dispatch({ type: 'SET_LOADING', payload: true })\n    dispatch({ type: 'SET_ERROR', payload: null })\n    try {\n      const response = await fetch(`${baseAPIURL}/courses`)\n      if (!response.ok) throw new Error('Failed to fetch courses')\n      const data = await response.json()\n      dispatch({ type: 'SET_COURSES', payload: data.docs })\n    } catch (e: unknown) {\n      dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n      dispatch({ type: 'SET_COURSES', payload: [] })\n    } finally {\n      dispatch({ type: 'SET_LOADING', payload: false })\n    }\n  }, [baseAPIURL])\n\n  const fetchTopics = useCallback(\n    async (courseId: DefaultDocumentIDType) => {\n      dispatch({ type: 'SET_LOADING', payload: true })\n      dispatch({ type: 'SET_ERROR', payload: null })\n      const query = qs.stringify({ where: { course: { equals: courseId } } })\n      try {\n        const response = await fetch(`${baseAPIURL}/topics?${query}`)\n        if (!response.ok) throw new Error('Failed to fetch topics')\n        const data = await response.json()\n        dispatch({ type: 'SET_TOPICS', payload: data.docs })\n      } catch (e: unknown) {\n        dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n        dispatch({ type: 'SET_TOPICS', payload: [] })\n      } finally {\n        dispatch({ type: 'SET_LOADING', payload: false })\n      }\n    },\n    [baseAPIURL],\n  )\n\n  const fetchLessons = useCallback(\n    async (topicId: DefaultDocumentIDType) => {\n      dispatch({ type: 'SET_LOADING', payload: true })\n      dispatch({ type: 'SET_ERROR', payload: null })\n      const query = qs.stringify({ where: { topic: { equals: topicId } } })\n      try {\n        const response = await fetch(`${baseAPIURL}/lessons?${query}`)\n        if (!response.ok) throw new Error('Failed to fetch lessons')\n        const data = await response.json()\n        dispatch({ type: 'SET_LESSONS', payload: data.docs })\n      } catch (e: unknown) {\n        dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n        dispatch({ type: 'SET_LESSONS', payload: [] })\n      } finally {\n        dispatch({ type: 'SET_LOADING', payload: false })\n      }\n    },\n    [baseAPIURL],\n  )\n\n  const fetchQuizzes = useCallback(\n    async (lessonId: DefaultDocumentIDType) => {\n      dispatch({ type: 'SET_LOADING', payload: true })\n      dispatch({ type: 'SET_ERROR', payload: null })\n      const query = qs.stringify({ where: { lesson: { equals: lessonId } } })\n      try {\n        const response = await fetch(`${baseAPIURL}/quizzes?${query}`)\n        if (!response.ok) throw new Error('Failed to fetch quizzes')\n        const data = await response.json()\n        dispatch({ type: 'SET_QUIZZES', payload: data.docs })\n      } catch (e: unknown) {\n        dispatch({ type: 'SET_ERROR', payload: e instanceof Error ? e : new Error('An unknown error occurred') })\n        dispatch({ type: 'SET_QUIZZES', payload: [] })\n      } finally {\n        dispatch({ type: 'SET_LOADING', payload: false })\n      }\n    },\n    [baseAPIURL],\n  )\n\n\n\n  const value: LMSContextType = {\n    users: state.users,\n    courses: state.courses,\n    topics: state.topics,\n    lessons: state.lessons,\n    progress: state.progress,\n    quizzes: state.quizzes,\n    certificates: state.certificates,\n    enrolledCourses: state.enrolledCourses,\n    completedCourses: state.completedCourses,\n    quizStarted: state.quizStarted,\n    enroll,\n    completeCourse,\n    completeLesson,\n    startQuiz,\n    setQuizCompleted,\n    setQuizExited,\n    submitQuiz,\n    addUserToGroup,\n    getProgress,\n    fetchProgress,\n    fetchUsers,\n    fetchCourses,\n    fetchTopics,\n    fetchLessons,\n    fetchQuizzes,\n    isLoading: state.isLoading,\n    error: state.error,\n  }\n\n  return <LMSContext.Provider value={value}>{children}</LMSContext.Provider>\n}\n\nexport const useLMS = (): LMSContextType => {\n  const context = use(LMSContext)\n  if (context === undefined) {\n    throw new Error('useLMS must be used within a LMSProvider')\n  }\n  return context\n}\n"],"names":["React","createContext","use","useCallback","useEffect","useReducer","qs","lmsReducer","initialState","defaultContext","users","courses","topics","lessons","progress","quizzes","certificates","enrolledCourses","completedCourses","quizStarted","enroll","completeCourse","completeLesson","startQuiz","setQuizCompleted","setQuizExited","submitQuiz","passed","score","message","addUserToGroup","getProgress","undefined","fetchProgress","fetchUsers","fetchCourses","fetchTopics","fetchLessons","fetchQuizzes","isLoading","error","LMSContext","defaultLocalStorage","key","LMSProvider","children","api","syncLocalStorage","localStorageConfig","apiRoute","serverURL","baseAPIURL","state","dispatch","type","payload","response","fetch","method","headers","credentials","status","ok","Error","data","json","coursesProgress","enrolledCoursesArray","Array","isArray","map","course","id","completedCoursesArray","e","storedProgress","localStorage","getItem","parsed","JSON","parse","normalizedProgress","completedLessons","lesson","completionPercentage","courseCompletion","completedQuizzes","quiz","normalizedEnrolledCourses","normalizedCompletedCourses","serializedState","stringify","setItem","courseId","options","requestBody","isGroup","companyName","isLeader","userId","body","lessonId","quizId","startedAt","Date","toISOString","completedAt","exitedAt","answers","groupId","role","refreshFromDB","find","cp","docs","query","where","equals","topicId","topic","value","Provider","useLMS","context"],"mappings":"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"}